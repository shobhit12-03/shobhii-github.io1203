#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

#define BLOCK_SIZE 512
#define MAX_NAME_LENGTH 50
#define MAX_BLOCKS 1024
#define MAX_CMD_LENGTH 200
#define MAX_ARG_LENGTH 100
#define MAX_DATA_LENGTH 512

typedef struct FreeBlock
{
    int blockIndex;
    struct FreeBlock *prev;
    struct FreeBlock *next;
} FreeBlock;

typedef struct FileNode
{
    char name[MAX_NAME_LENGTH];
    int isDirectory;
    int *blockPointers;
    int blocksAllocated;
    int contentSize;
    struct FileNode *parent;
    struct FileNode *next;
    struct FileNode *prev;
    struct FileNode *firstChild;
} FileNode;

unsigned char *virtualDisk;
int numBlocks = MAX_BLOCKS;
FreeBlock *freeHead = NULL;
FreeBlock *freeTail = NULL;
FileNode *rootDirectory = NULL;
FileNode *currentDirectory = NULL;

void insertFreeBlockAtTail(const int index)
{
    FreeBlock *newBlock = (FreeBlock *)malloc(sizeof(FreeBlock));
    newBlock->blockIndex = index;
    newBlock->next = NULL;
    newBlock->prev = freeTail;

    if (!freeHead)
    {
        freeHead = newBlock;
    }
    if (freeTail)
    {
        freeTail->next = newBlock;
    }
    freeTail = newBlock;
}

int allocateBlock()
{
    if (!freeHead)
    {
        return -1;
    }

    int index = freeHead->blockIndex;
    FreeBlock *tempBlock = freeHead;
    freeHead = freeHead->next;

    if (freeHead)
    {
        freeHead->prev = NULL;
    }
    else
    {
        freeTail = NULL;
    }

    free(tempBlock);
    return index;
}

void freeBlock(const int index)
{
    insertFreeBlockAtTail(index);
}

FileNode *createNode(const char *name, const int isDirectory)
{
    FileNode *node = (FileNode *)malloc(sizeof(FileNode));
    strcpy(node->name, name);
    node->isDirectory = isDirectory;
    node->blockPointers = NULL;
    node->blocksAllocated = 0;
    node->contentSize = 0;
    node->parent = NULL;
    node->next = NULL;
    node->prev = NULL;
    node->firstChild = NULL;
    return node;
}

void insertChild(FileNode *parent, FileNode *child)
{
    if (!parent->firstChild)
    {
        parent->firstChild = child;
        child->next = child->prev = child;
    }
    else
    {
        FileNode *lastChild = parent->firstChild->prev;
        lastChild->next = child;
        child->prev = lastChild;
        child->next = parent->firstChild;
        parent->firstChild->prev = child;
    }
    child->parent = parent;
}

FileNode *findChild(FileNode *parent, const char *name)
{
    if (!parent->firstChild)
    {
        return NULL;
    }

    FileNode *iterator = parent->firstChild;
    do
    {
        if (strcmp(iterator->name, name) == 0)
        {
            return iterator;
        }
        iterator = iterator->next;
    } while (iterator != parent->firstChild);

    return NULL;
}

void removeChild(FileNode *parent, FileNode *child)
{
    if (!parent->firstChild)
    {
        return;
    }

    if (child->next == child)
    {
        parent->firstChild = NULL;
    }
    else
    {
        if (parent->firstChild == child)
        {
            parent->firstChild = child->next;
        }
        child->prev->next = child->next;
        child->next->prev = child->prev;
    }
}

void makeDirectoryCommand(const char *name)
{
    if (findChild(currentDirectory, name))
    {
        printf("Directory already exists\n");
        return;
    }

    FileNode *directory = createNode(name, 1);
    insertChild(currentDirectory, directory);
    printf("Directory '%s' created successfully.\n", name);
}

void createFileCommand(const char *name)
{
    if (findChild(currentDirectory, name))
    {
        printf("File already exists\n");
        return;
    }

    FileNode *file = createNode(name, 0);
    insertChild(currentDirectory, file);
    printf("File '%s' created successfully.\n", name);
}

void writeFileCommand(const char *fileName, const char *data)
{
    FileNode *file = findChild(currentDirectory, fileName);
    if (!file || file->isDirectory)
    {
        printf("File not found\n");
        return;
    }

    if (file->blockPointers)
    {
        for (int i = 0; i < file->blocksAllocated; i++)
        {
            freeBlock(file->blockPointers[i]);
        }
        free(file->blockPointers);
        file->blockPointers = NULL;
        file->blocksAllocated = 0;
    }

    int length = strlen(data);
    int blocksNeeded = (int)ceil((double)length / BLOCK_SIZE);
    file->blockPointers = (int *)malloc(blocksNeeded * sizeof(int));

    for (int blockIndex = 0; blockIndex < blocksNeeded; blockIndex++)
    {
        int allocatedBlock = allocateBlock();
        if (allocatedBlock == -1)
        {
            printf("Not enough free blocks.\n");
            return;
        }

        file->blockPointers[blockIndex] = allocatedBlock;
        memcpy(virtualDisk + allocatedBlock * BLOCK_SIZE, data + blockIndex * BLOCK_SIZE, BLOCK_SIZE);
    }

    file->blocksAllocated = blocksNeeded;
    file->contentSize = length;
    printf("Data written successfully (size=%d bytes).\n", length);
}

void readFileCommand(const char *fileName)
{
    FileNode *file = findChild(currentDirectory, fileName);
    if (!file || file->isDirectory)
    {
        printf("File not found\n");
        return;
    }

    char *buffer = (char *)malloc(file->contentSize + 1);
    int bytesCopied = 0;

    for (int blockIndex = 0; blockIndex < file->blocksAllocated; blockIndex++)
    {
        int blockNumber = file->blockPointers[blockIndex];
        int bytesToCopy = (file->contentSize - bytesCopied > BLOCK_SIZE) ? BLOCK_SIZE : file->contentSize - bytesCopied;
        memcpy(buffer + bytesCopied, virtualDisk + blockNumber * BLOCK_SIZE, bytesToCopy);
        bytesCopied += bytesToCopy;
    }

    buffer[file->contentSize] = '\0';
    printf("%s\n", buffer);
    free(buffer);
}

void deleteFileCommand(const char *fileName)
{
    FileNode *file = findChild(currentDirectory, fileName);
    if (!file || file->isDirectory)
    {
        printf("File not found\n");
        return;
    }

    for (int blockIndex = 0; blockIndex < file->blocksAllocated; blockIndex++)
    {
        freeBlock(file->blockPointers[blockIndex]);
    }

    free(file->blockPointers);
    removeChild(currentDirectory, file);
    free(file);
    printf("File deleted successfully.\n");
}

void removeDirectoryCommand(const char *name)
{
    FileNode *directory = findChild(currentDirectory, name);
    if (!directory || !directory->isDirectory)
    {
        printf("Directory not found\n");
        return;
    }

    if (directory->firstChild)
    {
        printf("Directory not empty\n");
        return;
    }

    removeChild(currentDirectory, directory);
    free(directory);
    printf("Directory removed successfully.\n");
}

void listCommand()
{
    if (!currentDirectory->firstChild)
    {
        printf("(empty)\n");
        return;
    }

    FileNode *iterator = currentDirectory->firstChild;
    do
    {
        printf(iterator->isDirectory ? "%s/  " : "%s  ", iterator->name);
        iterator = iterator->next;
    } while (iterator != currentDirectory->firstChild);

    printf("\n");
}

void changeDirectoryCommand(const char *name)
{
    if (strcmp(name, "..") == 0)
    {
        if (currentDirectory->parent)
        {
            currentDirectory = currentDirectory->parent;
        }
        printf("Moved to %s\n", currentDirectory->name);
        return;
    }

    FileNode *directory = findChild(currentDirectory, name);
    if (!directory || !directory->isDirectory)
    {
        printf("Directory not found\n");
        return;
    }

    currentDirectory = directory;
    printf("Moved to %s\n", currentDirectory->name);
}

void printWorkingDirectory(FileNode *directory)
{
    if (!directory)
    {
        return;
    }

    if (directory->parent)
    {
        printWorkingDirectory(directory->parent);
        if (strcmp(directory->name, "/") != 0)
        {
            printf("/%s", directory->name);
        }
    }
    else
    {
        printf("/");
    }
}

void diskFreeCommand()
{
    int freeBlockCount = 0;
    for (FreeBlock *iterator = freeHead; iterator; iterator = iterator->next)
    {
        freeBlockCount++;
    }

    int usedBlocks = numBlocks - freeBlockCount;
    printf(
        "Total Blocks: %d\nUsed Blocks: %d\nFree Blocks: %d\nDisk Usage: %.2f%%\n",
        numBlocks, usedBlocks, freeBlockCount, (usedBlocks * 100.0) / numBlocks);
}

void initializeVFS()
{
    virtualDisk = (unsigned char *)malloc(numBlocks * BLOCK_SIZE);
    for (int blockIndex = 0; blockIndex < numBlocks; blockIndex++)
    {
        insertFreeBlockAtTail(blockIndex);
    }

    rootDirectory = createNode("/", 1);
    currentDirectory = rootDirectory;
}

int main(int argc, char *argv[])
{
    if (argc > 1)
    {
        numBlocks = atoi(argv[1]);
    }

    if (numBlocks <= 0 || numBlocks > MAX_BLOCKS)
    {
        numBlocks = MAX_BLOCKS;
    }

    initializeVFS();
    printf("Compact VFS ready. Type 'exit' to quit.\n");

    char command[MAX_CMD_LENGTH];
    char arg1[MAX_ARG_LENGTH];
    char arg2[MAX_DATA_LENGTH];

    while (1)
    {
        printf("%s > ", currentDirectory->name);
        fgets(command, sizeof(command), stdin);
        command[strcspn(command, "\n")] = 0;

        if (strncmp(command, "mkdir ", 6) == 0)
        {
            makeDirectoryCommand(command + 6);
        }
        else if (strncmp(command, "create ", 7) == 0)
        {
            createFileCommand(command + 7);
        }
        else if (strncmp(command, "write ", 6) == 0)
        {
            sscanf(command + 6, "%s \"%[^\"]\"", arg1, arg2);
            writeFileCommand(arg1, arg2);
        }
        else if (strncmp(command, "read ", 5) == 0)
        {
            readFileCommand(command + 5);
        }
        else if (strncmp(command, "delete ", 7) == 0)
        {
            deleteFileCommand(command + 7);
        }
        else if (strncmp(command, "rmdir ", 6) == 0)
        {
            removeDirectoryCommand(command + 6);
        }
        else if (strcmp(command, "ls") == 0)
        {
            listCommand();
        }
        else if (strncmp(command, "cd ", 3) == 0)
        {
            changeDirectoryCommand(command + 3);
        }
        else if (strcmp(command, "pwd") == 0)
        {
            printWorkingDirectory(currentDirectory);
            printf("\n");
        }
        else if (strcmp(command, "df") == 0)
        {
            diskFreeCommand();
        }
        else if (strcmp(command, "exit") == 0)
        {
            break;
        }
        else
        {
            printf("Unknown command\n");
        }
    }

    free(virtualDisk);
    return 0;
}
